. gen MI = 1 if substr(diag1,1,3)=="I21"
(3 missing values generated)
{\smallskip}
. bysort id (admdate sepdate) : gen ptr = 1 if admmode==1 | sepmode[_n-1]==1
(2 missing values generated)
{\smallskip}
. bysort id (admdate sepdate) : gen transferdist = admdate-sepdate[_n-1]
(1 missing value generated)
{\smallskip}
. gen tr = 1 if ptr == 1 \& inrange(transferdist,0,1)
(3 missing values generated)
{\smallskip}
. bysort id (admdate sepdate) : replace tr = 1 if transferdist==0 \& (MI==1 | MI[_n-1]==1)
(1 real change made)
{\smallskip}
. list, separator(0)
{\smallskip}
     {\TLC}\HLI{91}{\TRC}
     {\VBAR} id     admdate     sepdate   diag1   diag2   admmode   sepmode   MI   ptr   transf{\tytilde}t   tr {\VBAR}
     {\LFTT}\HLI{91}{\RGTT}
  1. {\VBAR}  1   01jan2020   01jan2020    I214                 0         1    1     .          .    . {\VBAR}
  2. {\VBAR}  1   02jan2020   03jan2020    I214    E119         1         1    1     1          1    1 {\VBAR}
  3. {\VBAR}  1   03jan2020   05jan2020    I499    E119         1         0    .     1          0    1 {\VBAR}
  4. {\VBAR}  1   05jan2020   06jan2020    J152    E119         1         1    .     1          0    1 {\VBAR}
  5. {\VBAR}  1   06jan2020   10jan2020    I214    E119         1         0    1     1          0    1 {\VBAR}
  6. {\VBAR}  1   10jan2020   15jan2020    I214    E119         0         0    1     .          0    1 {\VBAR}
  7. {\VBAR}  1   15jul2020   15jul2020    I509    E119         1         2    .     1        182    . {\VBAR}
     {\BLC}\HLI{91}{\BRC}
{\smallskip}
. *All the transfers are coded as such. 
. *Again, work on one at a time (in pairs)
. bysort id (admdate sepdate) : replace tr =. if tr[_n-1]==1
(2 real changes made, 2 to missing)
{\smallskip}
. bysort id (admdate sepdate) : replace MI = 1 if MI[_n+1]==1 \& tr[_n+1]==1
(0 real changes made)
{\smallskip}
. bysort id (admdate sepdate) : replace sepdate = sepdate[_n+1] if tr[_n+1]==1
(3 real changes made)
{\smallskip}
. bysort id (admdate sepdate) : replace sepmode = sepmode[_n+1] if tr[_n+1]==1
(1 real change made)
{\smallskip}
. bysort id (admdate sepdate) : drop if tr == 1 \& tr[_n-1]==.
(3 observations deleted)
{\smallskip}
. drop ptr tr transferdist
{\smallskip}
. list, separator(0)
{\smallskip}
     {\TLC}\HLI{69}{\TRC}
     {\VBAR} id     admdate     sepdate   diag1   diag2   admmode   sepmode   MI {\VBAR}
     {\LFTT}\HLI{69}{\RGTT}
  1. {\VBAR}  1   01jan2020   03jan2020    I214                 0         1    1 {\VBAR}
  2. {\VBAR}  1   03jan2020   06jan2020    I499    E119         1         1    . {\VBAR}
  3. {\VBAR}  1   06jan2020   15jan2020    I214    E119         1         0    1 {\VBAR}
  4. {\VBAR}  1   15jul2020   15jul2020    I509    E119         1         2    . {\VBAR}
     {\BLC}\HLI{69}{\BRC}
{\smallskip}
. *Repeat (with nested admissions cleared again, if necessary)
. forval i = 1/3 {\lbr}
  2. bysort id (admdate sepdate) : gen ptr = 1 if admmode==1 | sepmode[_n-1]==1
  3. bysort id (admdate sepdate) : gen transferdist = admdate-sepdate[_n-1]
  4. gen tr = 1 if ptr == 1 \& inrange(transferdist,0,1)
  5. bysort id (admdate sepdate) : replace tr = 1 if transferdist==0 \& (MI==1 | MI[_n-1]==1)
  6. bysort id (admdate sepdate) : replace tr =. if tr[_n-1]==1
  7. bysort id (admdate sepdate) : replace MI = 1 if MI[_n+1]==1 \& tr[_n+1]==1
  8. bysort id (admdate sepdate) : replace sepdate = sepdate[_n+1] if tr[_n+1]==1
  9. bysort id (admdate sepdate) : replace sepmode = sepmode[_n+1] if tr[_n+1]==1
 10. bysort id (admdate sepdate) : drop if tr == 1 \& tr[_n-1]==.
 11. drop ptr tr transferdist
 12. list, separator(0)
 13. {\rbr}
(1 missing value generated)
(1 missing value generated)
(2 missing values generated)
(0 real changes made)
(1 real change made, 1 to missing)
(0 real changes made)
(1 real change made)
(0 real changes made)
(1 observation deleted)
{\smallskip}
     {\TLC}\HLI{69}{\TRC}
     {\VBAR} id     admdate     sepdate   diag1   diag2   admmode   sepmode   MI {\VBAR}
     {\LFTT}\HLI{69}{\RGTT}
  1. {\VBAR}  1   01jan2020   06jan2020    I214                 0         1    1 {\VBAR}
  2. {\VBAR}  1   06jan2020   15jan2020    I214    E119         1         0    1 {\VBAR}
  3. {\VBAR}  1   15jul2020   15jul2020    I509    E119         1         2    . {\VBAR}
     {\BLC}\HLI{69}{\BRC}
(1 missing value generated)
(1 missing value generated)
(2 missing values generated)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(1 real change made)
(1 observation deleted)
{\smallskip}
     {\TLC}\HLI{69}{\TRC}
     {\VBAR} id     admdate     sepdate   diag1   diag2   admmode   sepmode   MI {\VBAR}
     {\LFTT}\HLI{69}{\RGTT}
  1. {\VBAR}  1   01jan2020   15jan2020    I214                 0         0    1 {\VBAR}
  2. {\VBAR}  1   15jul2020   15jul2020    I509    E119         1         2    . {\VBAR}
     {\BLC}\HLI{69}{\BRC}
(1 missing value generated)
(1 missing value generated)
(2 missing values generated)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 observations deleted)
{\smallskip}
     {\TLC}\HLI{69}{\TRC}
     {\VBAR} id     admdate     sepdate   diag1   diag2   admmode   sepmode   MI {\VBAR}
     {\LFTT}\HLI{69}{\RGTT}
  1. {\VBAR}  1   01jan2020   15jan2020    I214                 0         0    1 {\VBAR}
  2. {\VBAR}  1   15jul2020   15jul2020    I509    E119         1         2    . {\VBAR}
     {\BLC}\HLI{69}{\BRC}
{\smallskip}
